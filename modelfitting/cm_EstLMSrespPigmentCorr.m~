function LMSrespToSPDs = cm_EstLMSresponse(StimSPDs, sub, fv);


% load spectral power distribution of pigment-isolated stimuli
tmp = load('psychdataforPNAS');
if fv
    stimSPD = tmp.FOVstimSPD ;
else
    stimSPD = tmp.PERIstimSPD;
end

clear tmp;

wls    = cm_getDefaultWls;
ledspd = cm_getledSPD(wls);
mspd   = ledspd * ones(6,1);

absorbanceSpectra = cm_loadLMSabsorbance(fv);
melanopsinpeak = 482;

% melanopsin spectral absorbance
melanopsinAbsorbance = PhotopigmentNomogram(wls',melanopsinpeak,'StockmanSharpe');
AbsSpectra = [absorbanceSpectra melanopsinAbsorbance'];


%%
% pick up estimated photopigment densities based on foveal experiment
correctionflag = 1;
[~, ~, ~, tmp] = cm_dataTagSwitcher(sub, [], fv, correctionflag);

PODs       = tmp.pods;
macfactor  = tmp.mac;
lensfactor = tmp.lens;


% lens transmittance function
lT = cm_LensTransmittance(lensfactor, wls,'stockman2');

% macular transmittance function
mT = macular(macfactor, wls);

% whole eye transmittance function
eT = lT .* mT.transmittance';

Lambdashift = 0;


%%
StimAmp = 10;
InvStim =  stimSPD * StimSPDs * StimAmp;

LMSstand = ct_loadStandardObserverData;
LMSresp2TenPstimB = (LMSstand' * InvStim) ./  ((LMSstand' * mspd) * ones(1,size(InvStim, 2))) * 100;

if ~fv
    LMSIfun = cm_variableLMSI_PODandLambda(AbsSpectra, PODs, Lambdashift, eT);
    LMSafter = LMSIfun(:,1:3);
    LMSresp2TenPstimA = (LMSafter' * InvStim) ./  ((LMSafter' * mspd) * ones(1,size(InvStim, 2))) * 100;


end

% figure;
% plot3(LMSresp2TenPstimB(1,:),LMSresp2TenPstimB(2,:),LMSresp2TenPstimB(3,:),'o'); hold on
% plot3(LMSresp2TenPstimA(1,:),LMSresp2TenPstimA(2,:),LMSresp2TenPstimA(3,:),'ro')
% grid on, axis square; a = [-5 5]; xlim(a); ylim(a); 







% 
%     foo = load('decompStockLens');
%     lTs.dl1 = foo.dens_lens1(21:end);
%     lTs.dl2 = foo.dens_lens2(21:end);
%     lTs.met = 'stockman2';
%     
%  method1 = 'separate-l'; % 'separate' or 'same'
%     % give boundaries or not
%     method2 = 'fmincon'; % 'fmincon' or 'fminsearch'
%     dataset = 'peri';
%     
%     macdensity  = vcReadSpectra('macularPigment.mat', wls);
%     unitDensity = macdensity / 0.3521;
%  [POD MacDen LMSresp lensfactor] = cm_findPigmentDensity(spd,  ledspd, AbsSpectra, method1, method2, dataset, unitDensity, lTs);
